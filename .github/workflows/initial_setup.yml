name: ãƒ’ã‚¹ãƒˆãƒªã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾— + MLäº‹å‰å­¦ç¿’

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆåˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ï¼‰

permissions:
  contents: write

jobs:
  fetch-and-train:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install -r requirements.txt

      - name: ãƒ’ã‚¹ãƒˆãƒªã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—
        run: python scripts/fetch_historical.py

      - name: MLäº‹å‰å­¦ç¿’ (Bot #09)
        run: |
          python -c "
          from src.database import init_database, get_recent_prices
          from src.indicators import add_core_indicators
          from src.config import BOT_CONFIGS
          from src.bots.bot_09_ml_gate import BotMLGate
          import pandas as pd

          init_database()
          bot = BotMLGate(BOT_CONFIGS['09_ml_gate'])

          for symbol in ['BTC/USDT', 'ETH/USDT']:
              rows = get_recent_prices(symbol, limit=10000)
              if rows:
                  df = pd.DataFrame(rows)
                  for col in ['open','high','low','close','volume']:
                      df[col] = df[col].astype(float)
                  df = add_core_indicators(df)
                  bot.train(df, symbol)
                  print(f'{symbol} å­¦ç¿’å®Œäº†')
          "

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ¢ãƒ‡ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ models/ || true
          git diff --cached --quiet || git commit -m "ğŸ“Š åˆæœŸãƒ‡ãƒ¼ã‚¿ + MLãƒ¢ãƒ‡ãƒ«ä¿å­˜"
          git pull --rebase origin main || true
          git push
